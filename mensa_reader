#!/usr/bin/env perl
use Mojolicious::Lite;

use feature 'signatures';
no warnings 'experimental::signatures';

plugin Config => {file => app->home->rel_file('config')};
my $api_base = app->config('api')->{base_url};

# Detect proxy setting from environment
app->ua->proxy->detect;

# Load mensa data including Google Maps link
sub load_mensa_data ($id) {

    # Request and parse JSON
    my $url     = "$api_base/canteens/$id";
    my $data    = app->ua->get($url)->result->json;

    # Build Google Maps URL
    my $gm_url = 'https://www.google.com/maps/place'
        . "/$data->{coordinates}[0],$data->{coordinates}[1]";

    # Done
    return {
        %$data,
        api_url         => $url,
        google_maps_url => $gm_url,
    };
}

# Homepage: redirect to listing
get '/' => sub ($c) {
    $c->redirect_to('list');
} => 'home';

# List all known mensa items for selection
get '/list' => sub ($c) {

    # Retrieve data for each mensa (synchronously, sorted)
    my @mensa_ids   = @{ $c->config('mensa_ids') }; # deref array ref
    my %mensa_data  = map {$_ => load_mensa_data($_)} @mensa_ids;
    my @mensa_data  = sort {$a->{name} cmp $b->{name}} values %mensa_data;

    # Done
    $c->stash(mensa_data => \@mensa_data);

} => 'list';

app->start;
__DATA__

@@ list.html.ep
% layout 'default';
% title 'Welcome';
<h1>Yay! Mensa Reader!</h1>
<p>All known mensas:</p>
<ul>
% for my $d (@$mensa_data) {
    <li>
        <strong><%= $d->{name} %></strong><br>
        %= link_to "ðŸ“Œ $d->{address}" => $d->{google_maps_url}
    </li>
% }
</ul>

@@ layouts/default.html.ep
<!DOCTYPE html>
<html>
    <head>
        <title>MensaReader: <%= title %></title>
        %= stylesheet begin
            body { font-family: sans-serif; margin: 5em 8em }
            a:link { text-decoration: none }
            a:hover { background: #eee }
        % end
    </head>
    <body>
        %= content
    </body>
</html>
